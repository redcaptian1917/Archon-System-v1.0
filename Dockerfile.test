# --- Archon-App Test Dockerfile ---
# This container is for running the test suite.
FROM python:3.11-slim-bookworm

# 1. Set working directory
WORKDIR /app

# 2. Install all System Dependencies from the main Dockerfile
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    build-essential \
    python3-dev \
    libpq-dev \
    tor \
    proxychains4 \
    ansible \
    sshpass \
    macchanger \
    nmap \
    sqlmap \
    nikto \
    openvas-cli \
    sleuthkit \
    mat2 \
    ffmpeg \
    libnotify-bin \
    scrot \
    libopencv-dev \
    libportaudio2 \
    jq \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 3. Install GeckoDriver for Selenium/BrowserTool
RUN GECKO_VER="v0.34.0" && \
    wget "https://github.com/mozilla/geckodriver/releases/download/${GECKO_VER}/geckodriver-${GECKO_VER}-linux64.tar.gz" && \
    tar -xzf geckodriver-${GECKO_VER}-linux64.tar.gz && \
    mv geckodriver /usr/local/bin/ && \
    rm geckodriver-${GECKO_VER}-linux64.tar.gz

# 4. Install Python Dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install pytest

# 5. Copy the entire application structure
COPY . .

# 6. Set permissions for all scripts
RUN chmod +x /app/init-db.sh
RUN find /app -name "*.py" -exec chmod +x {} +
RUN find /app -name "*.sh" -exec chmod +x {} +

# 7. Default command (will be overridden by docker-compose)
CMD ["pytest"]
