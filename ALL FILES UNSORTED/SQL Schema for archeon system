-- SQL Schema for the Archon System --

-- 1. Privileges Table (Defines roles)
CREATE TABLE IF NOT EXISTS privileges (
    privilege_id SERIAL PRIMARY KEY,
    privilege_name VARCHAR(50) UNIQUE NOT NULL  -- e.g., 'admin', 'user', 'guest'
);

-- 2. Users Table (Stores user accounts and links to privileges)
CREATE TABLE IF NOT EXISTS users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL, -- For storing bcrypt hashes
    privilege_id INTEGER NOT NULL REFERENCES privileges(privilege_id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 3. Activity Logs Table (For transparent, observable actions)
CREATE TABLE IF NOT EXISTS activity_logs (
    log_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    action_type VARCHAR(100) NOT NULL, -- e.g., 'login', 'cli_command', 'add_credential'
    details TEXT,                      -- e.g., The actual command run
    status VARCHAR(20) NOT NULL        -- e.g., 'success', 'failure'
);

-- 4. Credentials Table (For storing the agent's secrets)
CREATE TABLE IF NOT EXISTS credentials (
    credential_id SERIAL PRIMARY KEY,
    owner_user_id INTEGER NOT NULL REFERENCES users(user_id),
    service_name VARCHAR(255) NOT NULL, -- e.g., 'gmail', 'gitlab', 'aws'
    username VARCHAR(255),
    encrypted_password BYTEA NOT NULL,  -- Encrypted data
    encryption_nonce BYTEA NOT NULL,    -- Nonce for AES-GCM
    encryption_tag BYTEA NOT NULL,      -- Auth tag for AES-GCM
    last_updated TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Pre-populate the privilege roles
INSERT INTO privileges (privilege_name) VALUES ('admin'), ('user'), ('guest')
ON CONFLICT (privilege_name) DO NOTHING;